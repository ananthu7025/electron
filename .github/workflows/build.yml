windows-build:
  runs-on: windows-latest
  steps:
    - uses: actions/checkout@v4

    # Install MSYS2 + required packages (cairo, pkg-config, libpng, libjpeg)
    - name: Setup MSYS2 and cairo deps (Windows)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cairo
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-libpng
          mingw-w64-x86_64-libjpeg-turbo

    # Ensure MSYS2 mingw64/bin is available to subsequent steps
    - name: Add MSYS2 mingw64 to PATH
      run: echo "C:\\msys64\\mingw64\\bin" >> $GITHUB_PATH

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # Optional: show pkg-config info for debugging (will print include/lib flags)
    - name: Debug pkg-config (cairo)
      shell: bash
      run: |
        pkg-config --cflags cairo || true
        pkg-config --libs cairo || true

    - name: Install Dependencies
      run: npm install
      env:
        # Let native build tooling find pkg-config from MSYS2
        PKG_CONFIG_PATH: C:\\msys64\\mingw64\\lib\\pkgconfig

    # If you need to rebuild native modules for Electron's ABI, run electron-rebuild
    - name: Rebuild native modules for Electron (optional)
      if: always()
      run: |
        npx electron-rebuild -f -w canvas || true

    - name: Build Windows Installer
      run: npm run build:win

    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: dist/*.exe
